⽹络层概述

- 网络层的主要任务是实现网络互联,进而实现数据包在各网络之间的传输 要实现网络层任务,需要解决以下问题:

- 网络层向运输层提供怎么样的服务?(可靠传输还是不可靠传输)

- 网络层寻址问题

- 路由选择问题

•

- 网络层的主要功能:

异构网络互联 - 异构网络:数据链路层和物理层均不同的网络

- 网络层的任务之一就是使异构网络实现互联

- 网络互联通常是指用路由器进行网络互联和路由选择

- 使用中继系统连接网络 物理层中继系统 数据链路层中继系统 网络层中继系统 网络层以上的中继系统 转发器,集线器 网桥,交换机 路由器 网 路由选择与分组转发 路由器的两个功能

- 路由选择【确定哪一条路径】

- 分组转发【当一个分组到达时所采取的动作】

拥塞控制 拥塞

- 在通信子网中,因出现过量的分组而引起网络性能下降的现象

- 此时所有节点都来不及接受分组,而要丢弃大量分组 判断是否拥塞的方法

- 观察网络吞吐量与网络负载的关系

- 随着通信子网负载的增加,吞吐量反而降低,即可能发生拥塞

- 轻度拥塞--->拥塞---->死锁 拥塞控制的方法

- 开环控制【静态】:事先考虑可能发生拥塞的情况,一旦系统启动,就不修改

- 闭环控制【动态】:采用检测网络监视哪里发生了拥塞,动态调整网络系统运行 SDN的基本概念

- 软件定义网络SDN采用集中式的控制层面和分布式的数据层面来控制网络

- 北向接口:SDN提供的编程接口

- 南向接口:SDN控制器和转发设备建立双向会话的接口(使用南向接口协议,如openflow)

- 东西向接口:SDN控制器集群内部控制器之间的通信接口

⽹络层设备 冲突域和⼴播域

- 域 = 冲突或广播在其中发生并传播的区域

- 冲突域 = 连接到同一物理介质上的所有节点的集合,这些节点之间存在介质争用的现象【OSI中第一层概念】

- 广播域 = 接受同样广播消息的节点集合【OSI中第二层概念】

- 局域网LAN特指使用路由器分割的网络,也就是广播域 路由器的组成和功能

- 路由器是一种具有多个输入/输出端口的专用计算机

- 路由器主要实现物理层,数据链路层,网络层的功能

- 路由器是网络层设备 路由器的任务

- 连接异构网络并完成路由转发

•

路由器的功能

- 分组转发:处理通过路由器的数据流

- 路由计算:通过和其他路由器进行路由协议的交互,完成路由表的计算

•

路由器的组成 路由选择部分 三个组成部分

- 路由选择处理机 + 路由选择协议 + 路由表

•

- 也叫控制部分,核心是路由选择处理机

- 任务是根据所选定的路由选择协议构造出路由表

- 同时不断更新路由信息和维护路由表 分组转发部分 三个组成部分

- 交换结构(本身就是一个网络) + 一组输入端口 + 一组输出端口

•

三种交换方式

- 通过存储器进行交换

- 通过总线进行交互

- 通过互联网络进行交互

•

•

路由表与路由转发

- 路由表是根据路由选择算法得出的,主要用途是路由选择

- 路由表的组成 = 目的网络的IP地址 + 子网掩码 + 下一跳IP地址 + 接口

- 路由表总是用软件实现,转发表可以用软件也可以用邮件实现

- 路由表不等于转发表,分组的实际转发是靠直接查找转发表,而不是直接查找路由表

- 路由表中默认路由的目的地址和子网掩码都是0.0.0.0 IP地址的基本知识 IP地址的定义

- MAC 的作用则是实现「直连」的两个设备之间通信,而 IP 则负责在「没有直连」的两个网络之间进行通信传输

- 源IP地址和目标IP地址在传输过程中是不会变化的(前提:没有使用 NAT 网络),只有源 MAC 地址和目标 MAC 一直在变化

- IPV4地址由 32 位正整数来表示,IP 地址在计算机是以二进制的方式处理的

- IP地址最大值 = 2^32 = 43亿左右

- IP 地址并不是根据主机台数来配置的,而是以网卡。像服务器、路由器等设备都是有 2 个以上的网卡,也就是它们会有 2 个以上的 IP 地址 分类编制的IPV4地址 分类 例题

⼀般不使⽤的IP地址 ABC类地址主要由网络号和主机号组成

- 网络号标志主机/路由器所连接到的网络

- 主机号标志主机/路由器 环回测试网络

- 127.x.x.x是环回自检地址,不指派

- 最小的环回地址:127.0.0.1

- 最大的环回地址:127.255.255.254 最大可用网络数 A类最大可用网络数 = 2网络号 - − 2 BC类最大可用网络数 = 2网络号 •

- 网络号为0,不指派

- 网络号为127,不指派 最大可用主机数 最大可用主机数 =2 主机号

- − 2

- 主机号全为 1 的地址是广播地址【255.255.255.255只能作为目的地址使用】

- 主机号全为 0 的地址是网络本身【0.0.0.0只能作为源地址使用】

DE地址

- D 类和 E 类地址没有主机号

- 不可用于主机 IP

- D 类常被用于多播

- E 类是预留的分类,暂时未使用 IP分类的优点

- 简单明了、选路(基于网络地址)简单 IP分类的缺点

- 同一网络下没有地址层次,缺少地址层次的灵活性

- C类地址254个太少了,B类地址65534个又太多了,不能很好的与显示网络匹配

- 上述两个缺点都可用【CIDR】解决 划分⼦⽹的IPV4地址 为什么要划分子网?

- 两级IP地址分类的地址空间流动率有时很低,用子网划分的方法来改善这个问题 划分子网的好处

- 增加子网的数量--->减少广播域的大小--->减少了主机的数量--->提高了IP地址的利用率

- 不增加网络的数量 什么是子网划分?

- 将主机地址分为两个部分【子网网络地址和子网主机地址】的过程

- 未做子网划分的 ip 地址:网络地址+主机地址

- 做子网划分后的 ip 地址:网络地址+(子网网络地址+子网主机地址)

如何得到网络地址?

- 将子网掩码和 IP 地址按位计算 AND,就可得到网络号 默认子网掩码

- A类:255.0.0.0

- B类:255.255.0.0

- C类:255.255.255.0 怎么进行子网划分?

- 假设对 C 类地址进行子网划分

- 网络地址 218.75.230.0,使用子网掩码 255.255.255.192 对其进行子网划分

- C 类地址中前 24 位是网络号,最后 8 位是主机号

- 根据子网掩码可知从 8 位主机号中借用 2 位作为子网号

- 由于子网网络地址被划分成 2 位,那么子网地址就有 4 个,分别是 00、01、10、11

- 划分后的 4 个子网如左图所示

⽆分类编制的IPV4地址【CIDR】

为什么引入CIDR

- CIDR消除了传统的A类,B类和C类地址,以及划分子网的概念 CIDR的作用?

- CIDR是一种归并技术,可以把小的网络汇聚成大的超网

- CIDR可以更加有效地分配IPV4的地址空间,并且可以在新的IPV6使用之前允许因特网的规模继续增长 CIDR的细节?

- CIDR的表示形式,最小地址,最大地址,地址数量,聚合网络数量,地址掩码 路由聚合是什么?

- 为了减小路由表的消耗,用路由聚合来聚合网络地址

- 网络前缀越长,地址快越小,路由越具体

- 最长前缀匹配:有多条路由可选的时候,选择网络前缀最长的那条 考试例题 答案:C

答案:C

IPV4地址的应用规划 定长的子网掩码 - 使用同一个子网掩码来划分子网 子网划分方式不灵活,只能划分出2 - !个子网

- 每个子网所分配的IP地址数量相同,容易造成IP地址浪费 变长的子网掩码 - 使用不同的子网掩码来划分子网

- 子网划分方式灵活:可以按需分配

- 每个子网所分配的IP地址数量可以不同,尽可能减少对IP地址的浪费 IP数据报的发送和转发过程 主机发送IP数据报 判断目的主机是否与自己在同一个网络

- 若在同一个网络,直接交付

- 若不在同一个网络,数据间接交付,传输给主机所在网络的默认网关(路由器),由默认网关帮忙转发

•

路由器转发IP数据报 检查IP数据报首部是否出错

- 若出错,则直接丢弃该IP数据报并通告源主机

- 若没有出错,则进行转发

•

- 根据IP数据报的目的地址在路由表中查找匹配的条目

- 若找到匹配的条目,则转发给条目中指示的下一跳

- 若找不到,则丢弃该IP数据报并通告源主机 静态路由配置及其可能产⽣的路由环路问题 静态路由配置 默认路由 特定主机路由 静态路由配置错误导致路由环路

- 为了防止IP数据报在路由环路中永久兜圈,在IP数据报首部设有生存时间TTL字段

- IP数据报进入路由器后,TTL字段的值减1。

- 若TTL的值不等于0,则被路由器转发,否则被丢弃 聚合不存在的网络而导致的路由环路

- 用黑洞路由条目配置解决 网络故障而导致的路由环路

- 用黑洞路由条目配置解决该问题

- 如果故障消失了,会暂时把黑洞路由条目设置为失效 IPV6 IPv6 地址的标识方法

- IPv6 地址长度是 128 位,是以每 16 位作为一组

- 每组用冒号 「:」 隔开。

- 如果出现连续的 0 时还可以将这些 0 省略,并用两个冒号 「::」隔开

- 但是,一个 IP 地址中只允许出现一次两个连续的冒号 IPv6 地址的结构

- 单播地址,用于一对一的通信

- 组播地址,用于一对多的通信

- 任播地址,用于通信最近的节点,最近的节点是由路由协议决定 IPv6 的亮点

- IPv6 可自动配置【即插即用】

- IPv6 首部长度采用固定的值 40 字节,去掉了校验和

- IPv6安全性提高了 IPv6 相比 IPv4 的首部改进 取消了首部校验和字段

- 因为在数据链路层和传输层都会校验,因此 IPv6 直接取消了 IP 的校验

•

取消了分片/重新组装相关字段

- 分片与重组是耗时的过程,IPv6 不允许在中间路由器进行分片与重组

- 这种操作只能在源与目标主机,这将大大提高了路由器转发的速度

•

取消选项字段

- 选项字段不再是标准 IP 首部的一部分了

- 但它并没有消失

- 而是可能出现在 IPv6 首部中的「下一个首部」指出的位置上

- 删除该选项字段使的 IPv6 的首部成为固定长度的 40 字节

•

IPV4⾸部 首部内容 - 首部长度,总长度,片偏移的基本单位分别为4B,1B,8B

IPV4分片 - 以太网MTU【最大传输单元】不超过1500

- DF=1时,分组的长度又超过MTU时,丢弃该分组,并用ICMP差错报文向源主机报告

- MF=1,表示接收到的分片不是最后一个分片

- 所有片中的有效数据核载都是8的倍数【偏移值的单位是8B】

- 在目的主机中对分片后的数据报重组

【例题】IPV4分片例题 IP协议相关技术 ICMP【互联⽹控制报⽂协议】

ICMP概述 五种差错报文 不应该发送差错报文的情况 ICMP询问方式 ICMP应用 ARP协议【IP地址到MAC地址的映射】

ARP主要内容 - ARP广播只在子网中传播

- 硬件地址只具有本地意义,每当路由器将IP数据报转发到一个具体的网络时,都需要重新封装源硬件地址和目的硬件地址

- 路由器在收到分组后,剥离该分组的数据链路层协议头,然后在分组被转发之前,给分组加上一个新的链路层协议头

- ARP请求是广播发送【由于不知道目标设备在哪里】

- ARP响应式单播发送 ARP过程 目的主机在本局域网

- 先在ARP高速缓存中查看有无目的IP地址与MAC地址的映射

- 有,则把硬件地址写入MAC帧,然后通过局域网把该MAC帧发往此硬件地址

- 无,则通过广播ARP请求分组,在获得目的主句的ARP响应分组后,将目的主机的IP地址与硬件地址写入ARP告诉缓存

•

目的主机不在本局域网

- 将IP分组发送给本局域网的路由器,先通过上述方式获得路由器的IP地址和硬件地址的映射关系

•

DHCP协议【动态主机配置协议】

DHCP主要内容 DHCP过程 虚拟专⽤⽹VPN和⽹络地址转换NAT

公有地址,私有地址 虚拟专用网VPN

网络地址转换NAT

- NAT的表项需要由管理员来添加 NAT转换流程

- 上图有两个客户端 192.168.1.10 和 192.168.1.11

- 与服务器 183.232.231.172 进行通信,并且这两个客户端的本地端口都是 1025

- 此时,两个私有 IP 都转换 IP 为公有地址 120.229.175.121,但以不同的端口号作为区分

- 于是,生成一个 NAPT 路由器的转换表

- 该表可以正确地转换地址跟端口的组合,令客户端 A、B 能同时与服务器之间进行通信

- 这种转换表在 NAT 路由器上自动生成。

- 例如,在 TCP 的情况下,建立 TCP 连接首次握手时的 SYN 包一经发出,就会生成这个表

- 后又随着收到关闭连接时发出 FIN 包的确认应答从表中被删除 路由选择协议概述 静态路由选择 动态路由选择 路由协议的主要特点 - 自适应 - 动态路由选择,能较好地适应网络状态的变化

- 分布式 - 路由器之间交换路由信息

- 分层次 - 将整个因特网划分为许多较小的自治系统

- 路由收敛:

分层次的路由选择协议 路由选择协议汇总 路由器的组成 路由选择部分 三个组成部分

- 路由选择处理机 + 路由选择协议 + 路由表

•

- 也叫控制部分,核心是路由选择处理机

- 任务是根据所选定的路由选择协议构造出路由表

- 同时不断更新路由信息和维护路由表 分组转发部分 三个组成部分

- 交换结构(本身就是一个网络) + 一组输入端口 + 一组输出端口

•

三种交换方式

- 通过存储器进行交换

- 通过总线进行交互

- 通过互联网络进行交互

•

三种路由协议的比较 RIP OSPF BGP

类型 内部 内部 外部 路由算法 距离-向量 链路状态 路径-向量 传递协议 UDP,应用层协议 IP,网络层协议 TCP,应用层协议 路径选择 跳数最少 代价最低 较好,非最佳 交换节点 和本节点相邻的路由器 网络中的所有路由器 和本节点相邻的路由器 交换内容 当前本路由器知道的全部信息,即自己的路由表 RIP不知道全网的拓扑结构 与本路由相邻的所有路由器的链路状态 任何一个路由器都知道自己所在区域的拓扑结构 首次 整个路由表 非首次 有变化的部分 路由信息协议RIP的⼯作原理 RIP基本概念 RIP工作原理

【举例】RIP基本工作过程

【举例】RIP路由条目更新规则 RIP坏消息传的慢的问题 开放最短路径优先OSPF的基本⼯作原理 OSPF基本概念

- 区域边界路由器:主⼲区域内,⽤于连接主⼲区域和其他下层区域的路由器

- 只要在主⼲区域中的路由器都叫做主⼲路由器

- 主⼲路由器可以兼做区域边界路由器

- ⾃治系统有4类路由器:区域内部路由器,主⼲路由器,区域边界路由器,⾃治域边界路由器 链路的代价 交互问候分组 计算最短路径的过程 五种分组类型 OSPF的基本工作过程 DR和BDR

区域 以上内容总结 边界⽹关协议BGP的⼯作原理

- BGP交换的⽹络可达性信息即:要到达某个⽹络所要结果的⼀系列⾃治系统/路径 第四章 ⽹络层 2022年8月31日 星期三 18:16